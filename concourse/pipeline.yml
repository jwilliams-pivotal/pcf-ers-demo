resources:
  - name: pcf-ers-demo
    type: git
    source:
      uri: https://github.com/jwilliams-pivotal/pcf-ers-demo
      branch: master

  - name: pcf-ers-demo-a
    type: git
    source:
      uri: https://github.com/jwilliams-pivotal/pcf-ers-demo
      branch: A

  - name: pcf-ers-demo-b
    type: git
    source:
      uri: https://github.com/jwilliams-pivotal/pcf-ers-demo
      branch: B

jobs:
  - name: test
    plan:
    - get: pcf-ers-demo
      trigger: true
    - task: test
      file: pcf-ers-demo/concourse/tasks/test.yml

  - name: package
    plan:
    - get: pcf-ers-demo
      trigger: true
      passed: [test]
    - task: package
      file: pcf-ers-demo/concourse/tasks/package.yml

  - name: zero-downtime-deploy
    plan:
    - get: pcf-ers-demo
      trigger: true
      passed: [package]
    - task: package
      file: pcf-ers-demo/concourse/tasks/package.yml
    - task: zero-downtime-deploy
      file: pcf-ers-demo/concourse/tasks/zero-downtime-push.yml

  - name: package-ab
    plan:
    - aggregate:
      - get: pcf-ers-demo-a
      - get: pcf-ers-demo-b
    - task: package-ab
      file: pcf-ers-demo/concourse/tasks/package.yml

  - name: deploy-ab
    plan:
    - get: pcf-ers-demo
    - get: pcf-ers-demo-a
      trigger: true
      passed: [package-ab]
    - get: pcf-ers-demo-b
      trigger: true
      passed: [package-ab]
    - task: deploy-ab
      file: pcf-ers-demo/concourse/tasks/package-ab.yml
